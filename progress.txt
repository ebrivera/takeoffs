## Codebase Patterns
- WallDetector uses `_MIN_WALL_LENGTH_PTS = 36` to exclude annotation ticks/leader lines and IQR-based outlier removal (`_OUTLIER_IQR_FACTOR = 3.0`) to exclude title block borders — both critical for accurate area computation on real drawings
- `_normalize_scale_text()` in `scale.py` canonicalizes Unicode quotes and whitespace before regex matching — two-step approach for resilient scale detection
- Integration tests in `backend/tests/integration/` — fixtures in `conftest.py`, test PDF at repo root `test_pdfs/first-floor.pdf`
- Path from `tests/integration/conftest.py` to repo root: `Path(__file__).resolve().parents[3]`
- PyMuPDF text blocks may contain multiple labels in one block (newline-separated) — normalize with `re.sub(r"\s+", " ", text)` before matching
- Title block text often uses spaced-out characters — collapse with `re.sub(r"\b(\w) (?=\w\b)", r"\1", text)` before searching
- Use `<Link>` from `next/link` for internal navigation — ESLint `@next/next/no-html-link-for-pages` rule forbids `<a href="/">`
- PyMuPDF `get_drawings()` "re" items have 3 elements: `("re", Rect, orientation_flag)` — check `len(item) >= 2` not `== 2`
- PyMuPDF drawing dict values are typed `object` — use `isinstance(raw, (int, float))` guard before `float()` for mypy strict
- Geometry models use frozen dataclasses (not Pydantic) for internal service types — consistent with pipeline.py pattern
- `cantena/geometry/` package: `extractor.py` (VectorExtractor, DrawingData, VectorPath, Point2D, BoundingRect, PathType), `scale.py` (ScaleDetector, ScaleResult, TextBlock, Confidence, parse_dimension_string), `walls.py` (WallDetector, WallSegment, WallAnalysis, Orientation), `measurement.py` (MeasurementService, PageMeasurements, MeasurementConfidence, pts_to_real_sf, pts_to_real_lf)
- Shapely 2.x needs `types-shapely` pip package for mypy stubs — `convex_hull` returns `BaseGeometry`, must `isinstance(hull, Polygon)` before `.exterior`
- HybridAnalyzer in `cantena/services/hybrid_analyzer.py`: HybridAnalyzer, HybridAnalysisResult, MergeDecision, MergeSource — merges geometry PageMeasurements with VLM VlmAnalysisResult
- Pipeline uses HybridAnalyzer when >50 vector paths detected (constant `_VECTOR_PATH_THRESHOLD` in pipeline.py) — falls back to VLM-only otherwise
- FastAPI endpoints returning non-JSON (e.g. PNG) need `response_model=None` decorator param — use `Response` or `JSONResponse` return types
- Debug endpoints use `APIRouter(prefix="/api/debug")` registered via `app.include_router()` in create_app
- `AnalyzeResponse` type in `types.ts` wraps the full backend response (estimate + analysis + metadata)
- Tailwind v4 uses `@theme inline` and CSS custom properties — reference with `var(--color-navy-xxx)` in className
- Python 3.11+ with pydantic v2 for domain models
- Project lives in `backend/` — source in `backend/cantena/`, tests in `backend/tests/`
- Quality gates: `pytest`, `mypy --strict cantena`, `ruff check cantena tests` (run from backend/ with venv activated)
- Use `source .venv/bin/activate` before running any Python tooling
- Frontend lives in `frontend/` — Next.js 14+ App Router with TypeScript strict mode
- Frontend quality gates: `npm run typecheck`, `npm run lint` (run from frontend/)
- Landing page at `/` is out of scope — product work lives under `/analyze` route
- Cost engine foundation (PRD 1) is complete — all models, engine, data, and formatting in `cantena/`
- Frontend types in `frontend/src/lib/types.ts` must mirror Python models exactly (enums as TS enums, interfaces for Pydantic models)
- Frontend API client in `frontend/src/lib/api.ts` — typed fetch wrappers
- `npm install` required before running quality gates (node_modules not committed)
- Use `npm run typecheck` and `npm run lint` from `frontend/` directory
- Services live in `cantena/services/` — new package created for PDF, VLM, pipeline services
- PyMuPDF (`fitz`) needs `# type: ignore[import-untyped]` for mypy (no stubs available)
- `anthropic` SDK has type stubs — do NOT add `# type: ignore[import-untyped]`
- Use `ImageBlockParam` and `TextBlockParam` from `anthropic.types` for typed message content
- System prompt strings must stay within 100-char line limit — use string concatenation `()`
- Use dataclasses (not Pydantic) for internal service result types — Pydantic reserved for domain models
- Empty PDFs (0 pages) are valid and should return empty result, not error
- Custom exceptions in `cantena/exceptions.py`: CantenaError base, PdfProcessingError, VlmAnalysisError, CostEstimationError
- Pipeline wraps errors from each stage into typed exceptions — don't double-wrap if already the correct type
- Use `TYPE_CHECKING` block for imports only used in type annotations (TC001/TC003) — runtime imports stay outside
- `AnalysisContext` from `vlm_analyzer` is used at runtime (instantiated in pipeline) — keep outside TYPE_CHECKING
- FastAPI `app.state` attributes are dynamically typed — mypy doesn't need `type: ignore[attr-defined]` comments
- Use `create_app(pipeline=mock)` factory pattern for test dependency injection — no env vars needed
- FastAPI TestClient for sync tests: `client.post("/api/analyze", files=..., data=...)` for multipart form
- Pydantic models used as FastAPI request body params need `# noqa: TCH001` — FastAPI resolves annotations at runtime
- `create_app(cost_engine=mock)` for testing /api/estimate — separate from pipeline injection
- `CostEngine.estimate(building, project_name)` takes BuildingModel + project name, returns CostEstimate
- `/api/analyze` response includes `building_model` field — full BuildingModel JSON for frontend parameter editing
- `estimateFromModel(building)` in `api.ts` POSTs BuildingModel JSON to `/api/estimate` — no PDF/VLM needed
- Use `structuredClone()` for deep-copying BuildingModel state in React (avoids mutation)
- VlmAnalyzer `timeout` param (default 60s) passes through to `anthropic.Anthropic(timeout=...)` — no need for httpx
- `GET /api/sample-estimate` returns a realistic pre-built estimate — no API key needed, good for demos
- API key check: `os.environ.get("ANTHROPIC_API_KEY")` in `/api/analyze` — returns 400 with helpful message if missing
- Use `@patch.dict("os.environ", {}, clear=True)` to test API key absence — env may have the key set
- Error boundary in `analyze/error-boundary.tsx` as class component; wired through `analyze/layout.tsx`

---

## 2026-02-07 - US-101
- What was implemented: Frontend scaffolding — added typecheck script, TypeScript interfaces matching all Python Pydantic models, typed API fetch wrapper, and /analyze page entry point.
- Files changed:
  - `frontend/package.json` — added `typecheck: "tsc --noEmit"` script
  - `frontend/src/lib/types.ts` — TypeScript enums and interfaces for BuildingType, StructuralSystem, ExteriorWall, MechanicalSystem, ElectricalService, FireProtection, Confidence, Location, ComplexityScores, BuildingModel, CostRange, DivisionCost, Assumption, BuildingSummary, EstimateMetadata, CostEstimate
  - `frontend/src/lib/api.ts` — `analyzePlan(file, location)` fetch wrapper targeting POST /api/analyze
  - `frontend/src/app/analyze/page.tsx` — minimal product analysis page at /analyze route
- **Learnings for future iterations:**
  - Node modules must be installed first (`npm install` from frontend/) before running quality gates
  - TypeScript enums match Python StrEnum values exactly — use string values not uppercase keys
  - `generated_at` is `string` in TS (JSON serialized datetime) not Date object
  - Path alias `@/*` maps to `./src/*` — use `@/lib/types` for imports
  - The PRD says `frontend/lib/types.ts` but actual path is `frontend/src/lib/types.ts` (under src/ per Next.js App Router convention)
---

## 2026-02-07 - US-102
- What was implemented: PDF processing service — PdfProcessor class that converts PDF pages to 200 DPI PNG images with text extraction and title block heuristic.
- Files changed:
  - `backend/pyproject.toml` — added PyMuPDF and Pillow dependencies
  - `backend/cantena/services/__init__.py` — new services package
  - `backend/cantena/services/pdf_processor.py` — PdfProcessor, PageResult, PdfProcessingResult classes
  - `backend/tests/test_pdf_processor.py` — 11 tests covering processing, text extraction, cleanup, and error handling
- **Learnings for future iterations:**
  - PyMuPDF (`import fitz`) has no type stubs — use `# type: ignore[import-untyped]` on the import
  - PyMuPDF cannot save a zero-page PDF (`ValueError: cannot save with zero pages`) — create test empty PDFs with raw bytes instead
  - Output directories must be created before fitz tries to write images (`mkdir(parents=True, exist_ok=True)`)
  - fitz uses 72 DPI as baseline — zoom factor = target_dpi / 72 (e.g., 200/72 ≈ 2.78)
  - Title block text lives in the bottom-right quadrant of construction drawings — use `page.get_text(clip=rect)` for extraction
  - Use `contextlib.suppress(OSError)` instead of try/except/pass per ruff SIM105
  - ruff `--fix` auto-handles I001 import sorting
---

## 2026-02-07 - US-103
- What was implemented: VLM analysis service — VlmAnalyzer class that sends construction drawing images to Anthropic Vision API and returns a structured BuildingModel.
- Files changed:
  - `backend/cantena/services/vlm_analyzer.py` — VlmAnalyzer, AnalysisContext, VlmAnalysisResult classes, SYSTEM_PROMPT constant
  - `backend/tests/test_vlm_analyzer.py` — 13 tests covering well-formed parsing, retry on malformed, missing field defaults, context passthrough, error handling
  - `backend/pyproject.toml` — added `anthropic>=0.39.0` dependency
- **Learnings for future iterations:**
  - `anthropic` SDK ships with type stubs — no `type: ignore` needed (unlike PyMuPDF)
  - Use `ImageBlockParam` and `TextBlockParam` from `anthropic.types` for typed API content arrays
  - mypy requires proper typed dicts for Anthropic API `messages[].content` — plain `dict[str, Any]` fails
  - Long string constants (system prompts) must use `()` string concatenation to stay under 100-char line limit for ruff E501
  - Mock `analyzer._client.messages.create` with `patch.object` for testing — mock response needs `.content[].type` and `.content[].text` attributes
  - Create minimal valid PNGs in tests using raw struct/zlib — no need for Pillow in test deps
  - Use `with (ctx1, ctx2):` syntax (Python 3.10+) instead of nested `with` per ruff SIM117
---

## 2026-02-07 - US-104
- What was implemented: Analysis pipeline — AnalysisPipeline orchestrator that chains PDF → VLM → CostEngine, plus custom exception hierarchy in cantena/exceptions.py.
- Files changed:
  - `backend/cantena/exceptions.py` — CantenaError base, PdfProcessingError, VlmAnalysisError, CostEstimationError
  - `backend/cantena/services/pipeline.py` — AnalysisPipeline class, PipelineResult dataclass, page selection heuristic
  - `backend/tests/test_pipeline.py` — 14 tests covering happy path, page selection, error wrapping, cleanup on failure
- **Learnings for future iterations:**
  - Pipeline wraps errors from each stage into typed exceptions — use `isinstance` check to avoid double-wrapping
  - Page selection heuristic: title block "floor plan" match > largest page by pixel area > page 1
  - `AnalysisContext` is used at runtime (instantiated in `analyze()`) — must import outside `TYPE_CHECKING`
  - All other pipeline type imports (`PdfProcessor`, `VlmAnalyzer`, `CostEngine`, result types) can go in `TYPE_CHECKING` since they're only in annotations
  - `time.monotonic()` for timing (not `time.time()`) — monotonic is not affected by system clock changes
  - `finally` block ensures cleanup even on exceptions — check `pdf_result is not None` before calling cleanup
  - Use `MagicMock(spec=ClassName)` for service mocks in tests — catches wrong method names
---

## 2026-02-07 - US-105
- What was implemented: FastAPI backend — create_app factory with POST /api/analyze (multipart PDF upload + form fields) and GET /api/health endpoints, CORS for localhost:3000, dependency injection module.
- Files changed:
  - `backend/pyproject.toml` — added fastapi, uvicorn, python-multipart dependencies
  - `backend/cantena/api/__init__.py` — new API package
  - `backend/cantena/api/deps.py` — create_pipeline() factory reading ANTHROPIC_API_KEY from env
  - `backend/cantena/api/app.py` — create_app factory, /api/health (200), /api/analyze (multipart form → PipelineResult JSON with estimate, summary_dict, export_dict)
  - `backend/tests/test_api.py` — 10 tests: health 200, analyze 200 with mocked pipeline, location passthrough, summary_dict/export_dict in response, non-PDF 400, missing fields 422, missing file 422, pipeline errors 500
- **Learnings for future iterations:**
  - FastAPI `app.state` is dynamically typed — mypy doesn't require `type: ignore[attr-defined]` for attribute access
  - `create_app(pipeline=mock)` factory pattern eliminates need for env vars in tests
  - With `from __future__ import annotations`, `AnalysisPipeline` in type annotations is string-evaluated — can use `TYPE_CHECKING` block
  - FastAPI TestClient: use `files={"file": (name, io, content_type)}` and `data={...}` for multipart form posts
  - CantenaError hierarchy maps cleanly to HTTP status codes: custom pipeline errors → 500, FastAPI validation → 422, explicit file checks → 400
---

## 2026-02-07 - US-106
- What was implemented: Upload UI — full /analyze page with drag-and-drop PDF upload, project name/city/state form, staged loading progress, error state with retry, and results view (header, division breakdown, collapsible assumptions, AI reasoning, metadata footer).
- Files changed:
  - `frontend/src/lib/types.ts` — added AnalysisInfo and AnalyzeResponse interfaces for full backend response
  - `frontend/src/lib/api.ts` — updated return type from CostEstimate to AnalyzeResponse, removed TODO comment
  - `frontend/src/app/analyze/page.tsx` — complete rewrite: upload form with drag-and-drop, form fields, loading states with staged progress, error handling, ResultsView with division table/assumptions/AI reasoning/metadata, DisclosurePanel and ConfidenceBadge components
- **Learnings for future iterations:**
  - Use `<Link>` from `next/link` for internal navigation — ESLint no-html-link-for-pages rule enforces this
  - Tailwind v4 CSS custom properties: use `var(--color-navy-xxx)` in arbitrary value syntax `[var(--color-navy-xxx)]`
  - `AnalyzeResponse` wraps the full backend response — estimate, summary_dict, export_dict, analysis (reasoning/warnings), processing_time_seconds, pages_analyzed
  - Staged loading progress uses setTimeout timers that are cleared in `finally` block to avoid stale state updates
  - File validation happens client-side (PDF extension + 50MB size) before API call
  - Results view sorts divisions by cost descending and highlights top 3 with subtle background color
---

## 2026-02-07 - US-107
- What was implemented: No new code needed — US-106 already implemented the full ResultsView with all US-107 acceptance criteria: header with project name/building summary/total cost/cost per SF, division breakdown table sorted by cost descending with top 3 highlighted, collapsible assumptions panel with confidence badges (green/yellow/red), collapsible AI reasoning panel with warnings, and metadata footer.
- Files changed: (none — only prd.json and progress.txt updated)
- **Learnings for future iterations:**
  - US-106 was implemented comprehensively and already satisfied US-107 requirements — always check existing code before writing new code
  - The ResultsView component in page.tsx handles the full results display: header card, division table, assumptions disclosure, AI reasoning disclosure, and metadata footer
  - ConfidenceBadge uses lowercase keys from backend (`high`/`medium`/`low`) and CSS `uppercase` for display — no case conversion needed
  - DisclosurePanel is a reusable collapsible component already in page.tsx — use it for any new collapsible sections
---

## 2026-02-07 - US-108
- What was implemented: POST /api/estimate endpoint — accepts BuildingModel JSON body, runs CostEngine directly (no PDF/VLM), returns CostEstimate JSON.
- Files changed:
  - `backend/cantena/api/app.py` — added `cost_engine` param to `create_app()`, `_get_cost_engine()` lazy-loader, `POST /api/estimate` endpoint, imported `BuildingModel` with `noqa: TCH001`
  - `backend/tests/test_api.py` — added `TestEstimateEndpoint` with 2 tests (valid 200, invalid 422), updated `_create_test_client` to accept `cost_engine` param
- **Learnings for future iterations:**
  - Pydantic models used as FastAPI endpoint parameters must be imported at runtime — `from __future__ import annotations` defers evaluation but FastAPI resolves via `get_type_hints()`. Use `# noqa: TCH001` to suppress ruff's TC001 rule.
  - `CostEngine.estimate(building, project_name)` — the project_name can be derived from location fields when no explicit name is available
  - The `create_app` factory now accepts both `pipeline` and `cost_engine` for independent DI
  - `_get_cost_engine()` uses lazy initialization via `create_default_engine()` — no env vars needed for this endpoint
---

## 2026-02-07 - US-109
- What was implemented: Parameter override UI — editable building parameters section with confidence badges, Recalculate button, toggle between AI estimate and adjusted estimate. Also added `building_model` to `/api/analyze` response and `estimateFromModel` API client function.
- Files changed:
  - `backend/cantena/api/app.py` — added `building_model` field to `/api/analyze` response (from VlmAnalysisResult)
  - `frontend/src/lib/types.ts` — added `building_model: BuildingModel` to `AnalyzeResponse` interface
  - `frontend/src/lib/api.ts` — added `estimateFromModel(building)` function POSTing to `/api/estimate`
  - `frontend/src/app/analyze/page.tsx` — added `BuildingParametersEditor` component with editable dropdowns/inputs, `FieldWithConfidence` wrapper, recalculate logic, AI/Adjusted toggle, human-readable enum label maps
- **Learnings for future iterations:**
  - Backend `/api/analyze` must include `building_model` in response so frontend can populate editable fields — was added to `result.analysis.building_model.model_dump()`
  - `structuredClone()` is the clean way to deep-copy BuildingModel for React state (avoids mutation of original)
  - `JSON.stringify` comparison works for change detection on BuildingModel since field order is deterministic from API
  - Enum label maps (`BUILDING_TYPE_LABELS`, `STRUCTURAL_LABELS`, `EXTERIOR_LABELS`) convert snake_case values to human-readable labels
  - FieldWithConfidence wraps each editable field with label + confidence badge — keeps the grid layout clean
  - Toggle between AI and adjusted estimates uses simple boolean state + conditional rendering
---

## 2026-02-07 - US-110
- What was implemented: Demo polish features — GET /api/sample-estimate endpoint (realistic 45K SF office in Baltimore), API key check on /api/analyze with helpful error, VLM 60-second timeout, "Try sample estimate" button on frontend, React error boundary wrapping /analyze route.
- Files changed:
  - `backend/cantena/api/app.py` — added `os` import, API key check in `/api/analyze`, `GET /api/sample-estimate` endpoint with realistic BuildingModel
  - `backend/cantena/services/vlm_analyzer.py` — added `timeout` param (default 60s) to `VlmAnalyzer.__init__`, passed to `anthropic.Anthropic(timeout=...)`
  - `backend/tests/test_api.py` — added `TestSampleEstimate` (sample returns 200 with full structure), `TestApiKeyCheck` (400 when no API key), imported `patch`
  - `frontend/src/lib/api.ts` — added `getSampleEstimate()` function calling GET /api/sample-estimate
  - `frontend/src/app/analyze/page.tsx` — added "Try sample estimate" button with `handleSample()`, `loadingSample` state
  - `frontend/src/app/analyze/error-boundary.tsx` — new file: `AnalyzeErrorBoundary` class component with "Something went wrong" + retry
  - `frontend/src/app/analyze/layout.tsx` — new file: wraps children with `AnalyzeErrorBoundary`
- **Learnings for future iterations:**
  - `anthropic.Anthropic(timeout=60.0)` works directly — no need for `httpx.Timeout` or custom client config
  - `@patch.dict("os.environ", {}, clear=True)` is needed to test API key absence when the env var is set globally
  - React error boundaries require class components — not possible with hooks alone
  - Error boundary goes in a separate file from page.tsx to keep it clean, wired through layout.tsx
  - Sample estimate endpoint uses deferred imports (inside the handler) to avoid circular imports and keep app.py light
  - The sample building model should match real use cases (3-story, 45K SF, steel-frame office, curtain wall, Baltimore)
---

## 2026-02-07 - US-111
- What was implemented: Docker Compose for local development — Dockerfiles for backend and frontend, docker-compose.yml, .env.example, and README.md with setup instructions.
- Files changed:
  - `backend/Dockerfile` — new file: Python 3.11-slim, PyMuPDF deps, pip install, uvicorn with reload
  - `frontend/Dockerfile` — new file: Node 20-slim, npm ci, next dev
  - `docker-compose.yml` — new file: backend (port 8000) + frontend (port 3000), volume mounts for hot reload, ANTHROPIC_API_KEY from .env
  - `.env.example` — new file: ANTHROPIC_API_KEY placeholder
  - `README.md` — updated: overview, prerequisites, quick start, dev without Docker, architecture
- **Learnings for future iterations:**
  - `NEXT_PUBLIC_API_URL` must point to `http://localhost:8000` (not `http://backend:8000`) because API calls happen in the browser, not server-side
  - Use `/app/node_modules` anonymous volume in frontend container to avoid overwriting node_modules from host mount
  - Backend uses `--factory` flag with uvicorn to call `create_app()` at startup
  - Keep Dockerfiles simple — no multi-stage builds for dev mode
---

## 2026-02-07 - US-301
- What was implemented: Vector path extraction from PDF pages — VectorExtractor class that uses PyMuPDF `page.get_drawings()` to extract lines, rectangles, curves, and polylines as structured coordinate data.
- Files changed:
  - `backend/cantena/geometry/__init__.py` — new geometry package
  - `backend/cantena/geometry/extractor.py` — VectorExtractor, DrawingData, VectorPath, Point2D, BoundingRect, DrawingStats, PathType models and extraction logic
  - `backend/tests/test_extractor.py` — 11 tests: known geometry extraction (rect + 2 lines), rect coordinates, line coordinates with colors, filter_by_region excludes outside paths, filter preserves metadata, stats computed correctly, stats empty data, empty page returns empty, text-only returns empty paths, BoundingRect.contains, BoundingRect.intersects
- **Learnings for future iterations:**
  - PyMuPDF `get_drawings()` "re" (rectangle) items are 3-element tuples `("re", Rect, orientation_flag)` — not 2 elements. Use `len(item) >= 2` guard.
  - PyMuPDF drawing dict values are typed as `object` from `dict[str, object]` — mypy strict requires `isinstance(raw, (int, float))` guard before calling `float()`.
  - `shape.draw_rect()` + `shape.finish()` + `shape.commit()` is the correct PyMuPDF sequence for creating test PDFs with known geometry.
  - Ruff E741 flags `l` as ambiguous variable name in generator expressions — use `seg` instead.
  - Frozen dataclasses (not Pydantic) are used for internal geometry models, consistent with existing service layer patterns (e.g., PipelineResult).
---

## 2026-02-07 - US-302
- What was implemented: Scale detection — ScaleDetector class with text-based scale parsing (architectural fractions, whole-inch, metric), dimension string parsing helper, dimension-based scale inference from nearby lines, and text block extraction from PDF pages.
- Files changed:
  - `backend/cantena/geometry/scale.py` — ScaleDetector, ScaleResult, TextBlock, Confidence models, parse_dimension_string helper, regex patterns for architectural/metric/whole-inch scales and dimension strings
  - `backend/tests/test_scale.py` — 24 tests: dimension parsing (feet-inches variants, decimal feet, unparseable), scale notation parsing (1/8"=1'-0" → 96, 1/4" → 48, 3/16" → 64, 1"=10'-0" → 120, 1:100, 1:50), messy text handling (extra spaces, no inch mark, embedded in title block), unparseable text returns None, dimension-based inference from nearby lines, text too far returns None, extract_text_blocks from real PDF
- **Learnings for future iterations:**
  - PyMuPDF `page.get_text("blocks")` returns tuples of `(x0, y0, x1, y1, text, block_no, block_type)` — block_type 0 = text
  - Architectural scale regex needs to handle Unicode quote marks (U+201D, U+2033, U+2019, U+2032) in addition to ASCII quotes
  - `_FRACTION_MAP` dict maps common architectural fractions to decimal inches — avoids eval/parsing fraction strings
  - Dimension-based scale inference uses 50pt proximity threshold between text center and line midpoint
  - `re.VERBOSE` flag allows readable multi-line regex patterns with inline comments
  - `fullmatch` vs `finditer`: use fullmatch for dimension strings (exact match), finditer for scale notations (embedded in text)
  - Deferred import of `PathType` inside `detect_from_dimensions` to avoid circular imports
---

## 2026-02-07 - US-303
- What was implemented: Wall detection and room boundary identification — WallDetector class with heuristic wall filtering (stroke width, orientation, color), parallel line pair detection for wall thickness, Shapely-based convex hull area computation, and outer boundary detection.
- Files changed:
  - `backend/pyproject.toml` — added `shapely>=2.0.0` dependency
  - `backend/cantena/geometry/walls.py` — new file: WallDetector, WallSegment, WallAnalysis, Orientation models, wall filtering heuristics, parallel pair detection, Shapely-based area computation
  - `backend/tests/test_walls.py` — 11 tests across 5 test classes (TestThickVsThinLines, TestParallelWallPairs, TestEnclosedArea, TestEmptyAnalysis, TestOrientation)
  - `prd.json` — US-303 passes: true
- **Learnings for future iterations:**
  - Shapely 2.x has type stubs (`types-shapely` pip package) — no `# type: ignore[import-untyped]` needed, but stubs must be installed separately
  - `MultiPoint.convex_hull` returns `BaseGeometry` — must use `isinstance(hull, Polygon)` check before accessing `.exterior` for mypy strict
  - Wall detection heuristic: stroke width >= 1.0 pts (~0.5mm), H/V orientation within ±2°, dark colors (RGB sum <= 1.0)
  - Parallel line pair detection uses perpendicular distance between midpoint and line — gap 2–20 pts range for wall thickness
  - `statistics.median()` for wall thickness from detected parallel pairs
  - Deferred shapely imports inside methods to avoid circular imports and keep module lightweight
---

## 2026-02-07 - US-304
- What was implemented: Scaled measurement service — MeasurementService class that combines VectorExtractor + ScaleDetector + WallDetector to produce real-world measurements (square feet, linear feet) from a single PDF page. Includes conversion functions pts_to_real_sf and pts_to_real_lf, MeasurementConfidence enum (HIGH/MEDIUM/LOW/NONE), and graceful fallbacks (no vectors -> NONE, no scale -> estimated scale -> LOW, walls but no boundary -> MEDIUM, walls + boundary -> HIGH).
- Files changed:
  - `backend/cantena/geometry/measurement.py` — MeasurementService, PageMeasurements, MeasurementConfidence, pts_to_real_sf, pts_to_real_lf
  - `backend/tests/test_measurement.py` — 8 tests: conversion functions (SF at 1/8" scale, LF at 1/8" scale, SF at 1/4" scale, single wall LF), full pipeline with known PDF (area ~5000 SF, perimeter ~300 LF), empty page NONE confidence, missing scale LOW confidence
  - `prd.json` — US-304 passes: true
- **Learnings for future iterations:**
  - Area formula: `area_sf = area_pts * (1/72)^2 * scale_factor^2 / 144` — converts sq points to sq paper inches, then to sq real inches, then to sq feet
  - Length formula: `length_lf = length_pts * (1/72) * scale_factor / 12` — converts points to paper inches, then to real inches, then to feet
  - At 1/8"=1'-0" (factor 96): 900pts × 450pts on paper = 100' × 50' = 5000 SF; perimeter 2700pts = 300 LF
  - MeasurementService uses the same frozen dataclass pattern as other geometry modules
  - Confidence cascade: NONE (no paths) -> LOW (estimated scale) -> MEDIUM (no outer boundary) -> HIGH (walls + boundary)
  - `_estimate_scale_from_page` returns a default 1/8"=1'-0" (factor 96) when no scale detected — conservative for architectural floor plans
  - Use `tempfile.NamedTemporaryFile` with context manager to satisfy ruff SIM115
---

## 2026-02-07 - US-305
- What was implemented: Hybrid analysis service — HybridAnalyzer class that merges geometry-computed measurements with VLM semantic analysis, producing a merged BuildingModel with documented MergeDecision records for each field.
- Files changed:
  - `backend/cantena/services/hybrid_analyzer.py` — new file: HybridAnalyzer, HybridAnalysisResult, MergeDecision, MergeSource models and merge logic
  - `backend/tests/test_hybrid_analyzer.py` — 11 tests across 5 test classes (TestGeometryHighConfidence, TestGeometryNoneFallsBackToVLM, TestBuildingTypeAlwaysFromVLM, TestMergeDecisionsDocumented, TestGeometryAnomalies)
  - `prd.json` — US-305 passes: true
- **Learnings for future iterations:**
  - `from __future__ import annotations` makes all annotations string-evaluated — TYPE_CHECKING imports work for all annotation-only types (no `# type: ignore[name-defined]` hacks needed)
  - Deferred import inside `_merge()` method (`from cantena.models.building import BuildingModel as _BuildingModel`) avoids circular imports when the type is used for construction at runtime but also in TYPE_CHECKING for annotations
  - `AnalysisContext` from vlm_analyzer can go in TYPE_CHECKING since it's only used in type signatures (not instantiated in hybrid_analyzer)
  - Merge logic: gross_sf from geometry if HIGH/MEDIUM confidence, else VLM; building_type/stories/structural/exterior/story_height always VLM; special_conditions merges both (geometry anomalies appended)
  - Area discrepancy threshold is >20% between geometry and VLM — triggers a special_condition note
  - MergeDecision records every field merge with source, reasoning, and confidence — provides trust/audit trail
---

## 2026-02-07 - US-306
- What was implemented: Updated AnalysisPipeline to optionally use HybridAnalyzer when vector geometry is available. Pipeline extracts vector paths from PDF, and when >50 paths are found and HybridAnalyzer is configured, uses hybrid analysis (geometry + VLM merge). Falls back to VLM-only otherwise. PipelineResult extended with geometry_available, measurement_confidence, and merge_decisions fields. /api/analyze response includes geometry_available and measurement_confidence.
- Files changed:
  - `backend/cantena/services/pipeline.py` — added hybrid_analyzer param to AnalysisPipeline, _count_vector_paths and _run_hybrid_analysis methods, PipelineResult geometry fields, _VECTOR_PATH_THRESHOLD constant
  - `backend/cantena/api/app.py` — added geometry_available and measurement_confidence to /api/analyze response
  - `backend/tests/test_pipeline.py` — added 5 tests: vector-rich PDF uses HybridAnalyzer, scanned PDF falls back to VLM-only, VLM-only result has geometry defaults, hybrid result populates geometry fields, backward compatible without HybridAnalyzer
  - `prd.json` — US-306 passes: true
- **Learnings for future iterations:**
  - `_count_vector_paths` and `_run_hybrid_analysis` use deferred fitz imports to open PDF independently of PdfProcessor — avoids coupling geometry extraction to the image rendering pipeline
  - Second deferred `import fitz` in same module doesn't need `# type: ignore[import-untyped]` — mypy only checks the import once per module
  - `patch.object(AnalysisPipeline, "_count_vector_paths", return_value=100)` is the cleanest way to test hybrid vs VLM-only branching — avoids needing real PDF files in tests
  - Frozen dataclass with mutable default (list) needs `field(default=None)` not `field(default_factory=list)` when None is the no-data sentinel
  - HybridAnalysisResult import needed in TYPE_CHECKING block for return type annotation in `_run_hybrid_analysis`
---

## 2026-02-07 - US-307
- What was implemented: Geometry debug visualization endpoint — POST /api/debug/geometry accepts PDF upload, runs full geometry pipeline (vector extraction, scale detection, wall detection, measurement), renders base PDF page as image with Pillow overlays (detected walls in red, outer boundary polygon in blue, info badge with area/scale/confidence), and returns either raw PNG or JSON with base64 PNG + measurement data.
- Files changed:
  - `backend/cantena/api/debug.py` — new file: APIRouter with POST /api/debug/geometry endpoint, _draw_info_badge helper for Pillow overlays, _measurements_to_dict for JSON serialization
  - `backend/cantena/api/app.py` — registered debug router via app.include_router(debug_router)
  - `backend/tests/test_debug_geometry.py` — 5 tests: PNG response for valid PDF (200 + PNG magic bytes), PNG response for empty geometry, JSON includes measurements with all expected fields, JSON wall segments have proper structure, non-PDF returns 400
  - `prd.json` — US-307 passes: true
- **Learnings for future iterations:**
  - FastAPI cannot handle `Response | dict[str, Any]` union return type — use `response_model=None` decorator param and always return `Response` (use `JSONResponse` for JSON output)
  - Pillow `ImageFont`/`ImageDraw` imports inside endpoint function are not visible to module-level helpers — use deferred `from PIL import ImageFont` inside the helper, or use `Any` type hint
  - `tempfile.NamedTemporaryFile` with `delete=False` triggers ruff SIM115 — use `with` context manager then access file by path after context exits
  - PyMuPDF `page.get_pixmap(matrix=fitz.Matrix(zoom, zoom))` renders PDF page at custom DPI — zoom=2.0 gives 144 DPI
  - `Image.frombytes("RGB", (pix.width, pix.height), pix.samples)` converts PyMuPDF Pixmap to Pillow Image for overlay drawing
  - APIRouter with `prefix="/api/debug"` keeps debug endpoints organized and separate from main API routes
  - `dataclasses.asdict(stats)` works for converting frozen dataclasses to JSON-serializable dicts, but BoundingRect with nested fields needs the dict to be serializable (asdict handles it recursively)
---

## 2026-02-08 - US-351
- What was implemented: Integration test fixtures and smoke tests for first-floor.pdf — conftest.py with `first_floor_pdf` and `first_floor_page` fixtures, ground truth constants, and smoke test file verifying PDF loads, page count, dimensions, and text content.
- Files changed:
  - `backend/tests/integration/__init__.py` — new integration test package
  - `backend/tests/integration/conftest.py` — `first_floor_pdf` fixture (yields fitz.Document, closes on teardown), `first_floor_page` fixture (yields first page), ground truth constants (EXPECTED_SCALE_FACTOR=48.0, EXPECTED_OVERALL_WIDTH_FT=32.0, EXPECTED_OVERALL_DEPTH_FT=16.0, EXPECTED_GROSS_AREA_SF=512.0, EXPECTED_TOTAL_WITH_PORCHES_SF=700.0, EXPECTED_ROOM_COUNT=7)
  - `backend/tests/integration/test_first_floor_smoke.py` — 4 smoke tests: PDF loads, has exactly 1 page, page has non-zero dimensions, page contains text
  - `prd.json` — US-351 passes: true
- **Learnings for future iterations:**
  - `test_pdfs/` is at repo root, not in `backend/` — `Path(__file__).resolve().parents[3]` from `tests/integration/conftest.py` reaches the repo root
  - `Generator` import from `collections.abc` needs to go in `TYPE_CHECKING` block per ruff TC003
  - Empty `if TYPE_CHECKING: pass` blocks trigger ruff TC005 — just remove them if unused
  - Integration test fixtures use `Generator` return type for yield fixtures that need cleanup
---

## 2026-02-08 - US-352
- What was implemented: Integration tests validating VectorExtractor against the real first-floor.pdf — verifies path count (>=50), line/rect stats, bounding box coverage (>=50% width, >=40% height), line width distribution (>=2 distinct widths), stroke color majority, filter_by_region reduction, and rasterized PDF skip fallback.
- Files changed:
  - `backend/tests/integration/test_first_floor_vectors.py` — 8 tests across TestVectorExtraction (7 tests) and TestRasterizedFallback (1 test)
  - `prd.json` — US-352 passes: true
- **Learnings for future iterations:**
  - VectorExtractor on first-floor.pdf extracts hundreds of paths — PDF has rich vector data, not rasterized
  - Line width distribution is logged for debugging wall detection thresholds — useful for US-354 tuning
  - `Counter[float]` typing works cleanly for counting line width occurrences
  - f-strings without placeholders trigger ruff F541 — use plain strings for static text
  - Integration tests with `print()` output need `-s` flag to see during development, but pass without it
---

## 2026-02-08 - US-353
- What was implemented: Integration tests validating ScaleDetector on the real first-floor.pdf, plus a two-step text normalization approach in `detect_from_text` (Unicode canonicalization + tolerant regex parsing). Tests cover text block extraction (>=20 blocks), scale detection from page text (scale_factor ~48.0), all 11 dimension string parses, dimension-based inference attempt, messy format resilience (Unicode quotes, extra whitespace, prime symbols), and correct behavior without API text interpreter.
- Files changed:
  - `backend/cantena/geometry/scale.py` — added `_normalize_scale_text()` function for two-step approach: normalizes Unicode quotes (\u201c/\u201d/\u2033/\u2018/\u2019/\u2032) to ASCII and collapses whitespace before regex matching
  - `backend/tests/integration/test_first_floor_scale.py` — new file: 23 tests across 6 test classes (TestTextBlockExtraction, TestDetectFromText, TestParseDimensionStrings, TestDetectFromDimensions, TestMessyFormatResilience, TestNoApiTextInterpreter)
  - `prd.json` — US-353 passes: true
- **Learnings for future iterations:**
  - Real PDF scale text is `SCALE: 1/4" =1'-0"` (note space before `=`) — existing regex already handles this but normalization makes it more robust
  - `detect_from_dimensions` on this drawing returns scale_factor ~144 (not ~48) because the closest dimension/line pairing is a short annotation line with a dimension value — dimension calibration is a fallback, not primary
  - The PDF has 118 text blocks total — plenty for analysis
  - `_normalize_scale_text` replaces all common Unicode quote variants (\u201c, \u201d, \u2033, \u2018, \u2019, \u2032, \u201e, \u00ab, \u00bb) to ASCII equivalents
  - Two-step approach (normalize → parse) is more resilient than adding more Unicode alternatives to regex character classes
---

## 2026-02-08 - US-354
- What was implemented: Integration tests validating WallDetector on the real first-floor.pdf, plus tuning of WallDetector heuristics to produce accurate results. Tests cover: ≥8 wall segments (got 42), ≥3 H/V each (23 H, 19 V), total wall length 80-250 LF (got 227.5), enclosed area 380-700 SF (got 548.0, +7% error vs 512 SF), wall thickness 3-12" (got 6.2"), and a diagnostic summary.
- Files changed:
  - `backend/tests/integration/test_first_floor_walls.py` — new file: 7 tests across TestWallDetection class (segment count, H/V counts, wall length range, area range, thickness range, diagnostic summary)
  - `backend/cantena/geometry/walls.py` — added `_MIN_WALL_LENGTH_PTS = 36` minimum segment length filter (excludes annotation ticks, dimension leader lines) and `_remove_length_outliers()` IQR-based outlier removal (excludes title block borders)
  - `prd.json` — US-354 passes: true
- **Learnings for future iterations:**
  - Unfiltered WallDetector picked up 238 segments (385 LF, 1771 SF area) — mostly annotation ticks and short marks under 1 ft
  - Two line widths on this drawing: 1.134 pts (dimension/annotation lines) and 1.417 pts (structural walls)
  - Minimum length filter of 36 pts (~2 ft at 1/4" scale) removed 181 out of 238 annotation/tick segments
  - Title block border was a 53.4 ft line at Y=751 spanning full page — IQR method (Q3 + 3*IQR upper bound) correctly identified and removed it
  - Dimension annotation leader lines at Y=86 and Y=684 (1.2 ft each) were also removed by the 36pt minimum length filter
  - Convex hull of wall endpoints gives ~548 SF (7% over expected 512 SF) — includes some porch area but well within ±25% tolerance
  - Wall thickness detection via parallel pair analysis: median 6.2 inches (~10.5 pts gap between parallel wall lines)
  - `pts_to_real_lf(pts, scale)` and `pts_to_real_sf(pts, scale)` from measurement.py are the correct conversion functions for integration tests
---

## 2026-02-08 - US-355
- What was implemented: Integration tests validating full MeasurementService.measure() pipeline on first-floor.pdf — verifies end-to-end measurement (scale detection → wall detection → area/perimeter/wall length computation), plus resilience tests with mocked mangled scale text ensuring graceful degradation.
- Files changed:
  - `backend/tests/integration/test_first_floor_measurement.py` — new file: 9 tests across TestMeasurementPipeline (7 tests) and TestMangledScaleResilience (2 tests)
  - `prd.json` — US-355 passes: true
- **Learnings for future iterations:**
  - MeasurementService.measure() on first-floor.pdf achieves HIGH confidence: scale_factor=48.0, gross_area=548.0 SF (+7% vs 512), perimeter=97.9 LF, wall_length=227.5 LF, 42 walls
  - When text extraction returns empty blocks (mangled text), detect_from_text and detect_from_dimensions both return None → pipeline falls back to estimated scale (factor=96) with LOW confidence, area balloons to ~2192 SF (because scale_factor doubles)
  - `patch.object(ScaleDetector, "extract_text_blocks", return_value=[])` is the cleanest way to simulate text extraction failure without needing a real mangled PDF
  - The pipeline never crashes on missing text — graceful degradation works: result is always returned, confidence degrades to LOW
---

## 2026-02-08 - US-356
- What was implemented: Integration tests validating text and room label extraction from first-floor.pdf — verifies all 9 expected room labels found (case-insensitive with newline normalization), label positions within drawing content area, spatial separation of distinct label blocks, coarse left/right zone mapping, at least 10 dimension text blocks, and title block fields (SCALE, 1/4, A1.2, 1ST FLOOR, AMERICAN FARMHOUSE) in border areas.
- Files changed:
  - `backend/tests/integration/test_first_floor_rooms.py` — new file: 6 tests across 6 test classes (TestRoomLabelExtraction, TestRoomLabelPositions, TestRoomLabelSpatialSeparation, TestCoarseZoneMapping, TestDimensionBlocks, TestTitleBlockFields)
  - `prd.json` — US-356 passes: true
- **Learnings for future iterations:**
  - PyMuPDF text blocks may contain multiple room labels in one block (e.g. "LIVING ROOM\nKITCHEN") — normalize newlines to spaces before label matching
  - "BACK PORCH" appears as "BACK \nPORCH" (split across lines within one text block) — `re.sub(r"\s+", " ", text)` normalization is essential
  - Title block text uses spaced-out characters: "A M E R I C A N  F A R M H O U S E" — collapse with `re.sub(r"\b(\w) (?=\w\b)", r"\1", text)` then normalize remaining whitespace
  - Title block elements spread across page edges: SCALE at lower-left (148, 760), AMERICAN FARMHOUSE at right-center (1161, 363), sheet number at lower-right (1152, 766) — search border areas (right 15% OR bottom 15%) not just lower-right quadrant
  - Spatial separation test must de-duplicate by text block position — labels sharing the same PDF text block (e.g. LIVING ROOM + KITCHEN at distance 0) are acceptable for open-plan rooms
  - 21 dimension text blocks found, well above the 10 minimum threshold
  - All 9 room labels found, distributed: left half (4): LIVING ROOM, KITCHEN, FRONT PORCH, LAUNDRY; right half (5): DINING, BACK PORCH, UTILITY, WC, COATS
---

