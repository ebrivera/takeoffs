## Codebase Patterns
- Use `<Link>` from `next/link` for internal navigation — ESLint `@next/next/no-html-link-for-pages` rule forbids `<a href="/">`
- `AnalyzeResponse` type in `types.ts` wraps the full backend response (estimate + analysis + metadata)
- Tailwind v4 uses `@theme inline` and CSS custom properties — reference with `var(--color-navy-xxx)` in className
- Python 3.11+ with pydantic v2 for domain models
- Project lives in `backend/` — source in `backend/cantena/`, tests in `backend/tests/`
- Quality gates: `pytest`, `mypy --strict cantena`, `ruff check cantena tests` (run from backend/ with venv activated)
- Use `source .venv/bin/activate` before running any Python tooling
- Frontend lives in `frontend/` — Next.js 14+ App Router with TypeScript strict mode
- Frontend quality gates: `npm run typecheck`, `npm run lint` (run from frontend/)
- Landing page at `/` is out of scope — product work lives under `/analyze` route
- Cost engine foundation (PRD 1) is complete — all models, engine, data, and formatting in `cantena/`
- Frontend types in `frontend/src/lib/types.ts` must mirror Python models exactly (enums as TS enums, interfaces for Pydantic models)
- Frontend API client in `frontend/src/lib/api.ts` — typed fetch wrappers
- `npm install` required before running quality gates (node_modules not committed)
- Use `npm run typecheck` and `npm run lint` from `frontend/` directory
- Services live in `cantena/services/` — new package created for PDF, VLM, pipeline services
- PyMuPDF (`fitz`) needs `# type: ignore[import-untyped]` for mypy (no stubs available)
- `anthropic` SDK has type stubs — do NOT add `# type: ignore[import-untyped]`
- Use `ImageBlockParam` and `TextBlockParam` from `anthropic.types` for typed message content
- System prompt strings must stay within 100-char line limit — use string concatenation `()`
- Use dataclasses (not Pydantic) for internal service result types — Pydantic reserved for domain models
- Empty PDFs (0 pages) are valid and should return empty result, not error
- Custom exceptions in `cantena/exceptions.py`: CantenaError base, PdfProcessingError, VlmAnalysisError, CostEstimationError
- Pipeline wraps errors from each stage into typed exceptions — don't double-wrap if already the correct type
- Use `TYPE_CHECKING` block for imports only used in type annotations (TC001/TC003) — runtime imports stay outside
- `AnalysisContext` from `vlm_analyzer` is used at runtime (instantiated in pipeline) — keep outside TYPE_CHECKING
- FastAPI `app.state` attributes are dynamically typed — mypy doesn't need `type: ignore[attr-defined]` comments
- Use `create_app(pipeline=mock)` factory pattern for test dependency injection — no env vars needed
- FastAPI TestClient for sync tests: `client.post("/api/analyze", files=..., data=...)` for multipart form
- Pydantic models used as FastAPI request body params need `# noqa: TCH001` — FastAPI resolves annotations at runtime
- `create_app(cost_engine=mock)` for testing /api/estimate — separate from pipeline injection
- `CostEngine.estimate(building, project_name)` takes BuildingModel + project name, returns CostEstimate
- `/api/analyze` response includes `building_model` field — full BuildingModel JSON for frontend parameter editing
- `estimateFromModel(building)` in `api.ts` POSTs BuildingModel JSON to `/api/estimate` — no PDF/VLM needed
- Use `structuredClone()` for deep-copying BuildingModel state in React (avoids mutation)

---

## 2026-02-07 - US-101
- What was implemented: Frontend scaffolding — added typecheck script, TypeScript interfaces matching all Python Pydantic models, typed API fetch wrapper, and /analyze page entry point.
- Files changed:
  - `frontend/package.json` — added `typecheck: "tsc --noEmit"` script
  - `frontend/src/lib/types.ts` — TypeScript enums and interfaces for BuildingType, StructuralSystem, ExteriorWall, MechanicalSystem, ElectricalService, FireProtection, Confidence, Location, ComplexityScores, BuildingModel, CostRange, DivisionCost, Assumption, BuildingSummary, EstimateMetadata, CostEstimate
  - `frontend/src/lib/api.ts` — `analyzePlan(file, location)` fetch wrapper targeting POST /api/analyze
  - `frontend/src/app/analyze/page.tsx` — minimal product analysis page at /analyze route
- **Learnings for future iterations:**
  - Node modules must be installed first (`npm install` from frontend/) before running quality gates
  - TypeScript enums match Python StrEnum values exactly — use string values not uppercase keys
  - `generated_at` is `string` in TS (JSON serialized datetime) not Date object
  - Path alias `@/*` maps to `./src/*` — use `@/lib/types` for imports
  - The PRD says `frontend/lib/types.ts` but actual path is `frontend/src/lib/types.ts` (under src/ per Next.js App Router convention)
---

## 2026-02-07 - US-102
- What was implemented: PDF processing service — PdfProcessor class that converts PDF pages to 200 DPI PNG images with text extraction and title block heuristic.
- Files changed:
  - `backend/pyproject.toml` — added PyMuPDF and Pillow dependencies
  - `backend/cantena/services/__init__.py` — new services package
  - `backend/cantena/services/pdf_processor.py` — PdfProcessor, PageResult, PdfProcessingResult classes
  - `backend/tests/test_pdf_processor.py` — 11 tests covering processing, text extraction, cleanup, and error handling
- **Learnings for future iterations:**
  - PyMuPDF (`import fitz`) has no type stubs — use `# type: ignore[import-untyped]` on the import
  - PyMuPDF cannot save a zero-page PDF (`ValueError: cannot save with zero pages`) — create test empty PDFs with raw bytes instead
  - Output directories must be created before fitz tries to write images (`mkdir(parents=True, exist_ok=True)`)
  - fitz uses 72 DPI as baseline — zoom factor = target_dpi / 72 (e.g., 200/72 ≈ 2.78)
  - Title block text lives in the bottom-right quadrant of construction drawings — use `page.get_text(clip=rect)` for extraction
  - Use `contextlib.suppress(OSError)` instead of try/except/pass per ruff SIM105
  - ruff `--fix` auto-handles I001 import sorting
---

## 2026-02-07 - US-103
- What was implemented: VLM analysis service — VlmAnalyzer class that sends construction drawing images to Anthropic Vision API and returns a structured BuildingModel.
- Files changed:
  - `backend/cantena/services/vlm_analyzer.py` — VlmAnalyzer, AnalysisContext, VlmAnalysisResult classes, SYSTEM_PROMPT constant
  - `backend/tests/test_vlm_analyzer.py` — 13 tests covering well-formed parsing, retry on malformed, missing field defaults, context passthrough, error handling
  - `backend/pyproject.toml` — added `anthropic>=0.39.0` dependency
- **Learnings for future iterations:**
  - `anthropic` SDK ships with type stubs — no `type: ignore` needed (unlike PyMuPDF)
  - Use `ImageBlockParam` and `TextBlockParam` from `anthropic.types` for typed API content arrays
  - mypy requires proper typed dicts for Anthropic API `messages[].content` — plain `dict[str, Any]` fails
  - Long string constants (system prompts) must use `()` string concatenation to stay under 100-char line limit for ruff E501
  - Mock `analyzer._client.messages.create` with `patch.object` for testing — mock response needs `.content[].type` and `.content[].text` attributes
  - Create minimal valid PNGs in tests using raw struct/zlib — no need for Pillow in test deps
  - Use `with (ctx1, ctx2):` syntax (Python 3.10+) instead of nested `with` per ruff SIM117
---

## 2026-02-07 - US-104
- What was implemented: Analysis pipeline — AnalysisPipeline orchestrator that chains PDF → VLM → CostEngine, plus custom exception hierarchy in cantena/exceptions.py.
- Files changed:
  - `backend/cantena/exceptions.py` — CantenaError base, PdfProcessingError, VlmAnalysisError, CostEstimationError
  - `backend/cantena/services/pipeline.py` — AnalysisPipeline class, PipelineResult dataclass, page selection heuristic
  - `backend/tests/test_pipeline.py` — 14 tests covering happy path, page selection, error wrapping, cleanup on failure
- **Learnings for future iterations:**
  - Pipeline wraps errors from each stage into typed exceptions — use `isinstance` check to avoid double-wrapping
  - Page selection heuristic: title block "floor plan" match > largest page by pixel area > page 1
  - `AnalysisContext` is used at runtime (instantiated in `analyze()`) — must import outside `TYPE_CHECKING`
  - All other pipeline type imports (`PdfProcessor`, `VlmAnalyzer`, `CostEngine`, result types) can go in `TYPE_CHECKING` since they're only in annotations
  - `time.monotonic()` for timing (not `time.time()`) — monotonic is not affected by system clock changes
  - `finally` block ensures cleanup even on exceptions — check `pdf_result is not None` before calling cleanup
  - Use `MagicMock(spec=ClassName)` for service mocks in tests — catches wrong method names
---

## 2026-02-07 - US-105
- What was implemented: FastAPI backend — create_app factory with POST /api/analyze (multipart PDF upload + form fields) and GET /api/health endpoints, CORS for localhost:3000, dependency injection module.
- Files changed:
  - `backend/pyproject.toml` — added fastapi, uvicorn, python-multipart dependencies
  - `backend/cantena/api/__init__.py` — new API package
  - `backend/cantena/api/deps.py` — create_pipeline() factory reading ANTHROPIC_API_KEY from env
  - `backend/cantena/api/app.py` — create_app factory, /api/health (200), /api/analyze (multipart form → PipelineResult JSON with estimate, summary_dict, export_dict)
  - `backend/tests/test_api.py` — 10 tests: health 200, analyze 200 with mocked pipeline, location passthrough, summary_dict/export_dict in response, non-PDF 400, missing fields 422, missing file 422, pipeline errors 500
- **Learnings for future iterations:**
  - FastAPI `app.state` is dynamically typed — mypy doesn't require `type: ignore[attr-defined]` for attribute access
  - `create_app(pipeline=mock)` factory pattern eliminates need for env vars in tests
  - With `from __future__ import annotations`, `AnalysisPipeline` in type annotations is string-evaluated — can use `TYPE_CHECKING` block
  - FastAPI TestClient: use `files={"file": (name, io, content_type)}` and `data={...}` for multipart form posts
  - CantenaError hierarchy maps cleanly to HTTP status codes: custom pipeline errors → 500, FastAPI validation → 422, explicit file checks → 400
---

## 2026-02-07 - US-106
- What was implemented: Upload UI — full /analyze page with drag-and-drop PDF upload, project name/city/state form, staged loading progress, error state with retry, and results view (header, division breakdown, collapsible assumptions, AI reasoning, metadata footer).
- Files changed:
  - `frontend/src/lib/types.ts` — added AnalysisInfo and AnalyzeResponse interfaces for full backend response
  - `frontend/src/lib/api.ts` — updated return type from CostEstimate to AnalyzeResponse, removed TODO comment
  - `frontend/src/app/analyze/page.tsx` — complete rewrite: upload form with drag-and-drop, form fields, loading states with staged progress, error handling, ResultsView with division table/assumptions/AI reasoning/metadata, DisclosurePanel and ConfidenceBadge components
- **Learnings for future iterations:**
  - Use `<Link>` from `next/link` for internal navigation — ESLint no-html-link-for-pages rule enforces this
  - Tailwind v4 CSS custom properties: use `var(--color-navy-xxx)` in arbitrary value syntax `[var(--color-navy-xxx)]`
  - `AnalyzeResponse` wraps the full backend response — estimate, summary_dict, export_dict, analysis (reasoning/warnings), processing_time_seconds, pages_analyzed
  - Staged loading progress uses setTimeout timers that are cleared in `finally` block to avoid stale state updates
  - File validation happens client-side (PDF extension + 50MB size) before API call
  - Results view sorts divisions by cost descending and highlights top 3 with subtle background color
---

## 2026-02-07 - US-107
- What was implemented: No new code needed — US-106 already implemented the full ResultsView with all US-107 acceptance criteria: header with project name/building summary/total cost/cost per SF, division breakdown table sorted by cost descending with top 3 highlighted, collapsible assumptions panel with confidence badges (green/yellow/red), collapsible AI reasoning panel with warnings, and metadata footer.
- Files changed: (none — only prd.json and progress.txt updated)
- **Learnings for future iterations:**
  - US-106 was implemented comprehensively and already satisfied US-107 requirements — always check existing code before writing new code
  - The ResultsView component in page.tsx handles the full results display: header card, division table, assumptions disclosure, AI reasoning disclosure, and metadata footer
  - ConfidenceBadge uses lowercase keys from backend (`high`/`medium`/`low`) and CSS `uppercase` for display — no case conversion needed
  - DisclosurePanel is a reusable collapsible component already in page.tsx — use it for any new collapsible sections
---

## 2026-02-07 - US-108
- What was implemented: POST /api/estimate endpoint — accepts BuildingModel JSON body, runs CostEngine directly (no PDF/VLM), returns CostEstimate JSON.
- Files changed:
  - `backend/cantena/api/app.py` — added `cost_engine` param to `create_app()`, `_get_cost_engine()` lazy-loader, `POST /api/estimate` endpoint, imported `BuildingModel` with `noqa: TCH001`
  - `backend/tests/test_api.py` — added `TestEstimateEndpoint` with 2 tests (valid 200, invalid 422), updated `_create_test_client` to accept `cost_engine` param
- **Learnings for future iterations:**
  - Pydantic models used as FastAPI endpoint parameters must be imported at runtime — `from __future__ import annotations` defers evaluation but FastAPI resolves via `get_type_hints()`. Use `# noqa: TCH001` to suppress ruff's TC001 rule.
  - `CostEngine.estimate(building, project_name)` — the project_name can be derived from location fields when no explicit name is available
  - The `create_app` factory now accepts both `pipeline` and `cost_engine` for independent DI
  - `_get_cost_engine()` uses lazy initialization via `create_default_engine()` — no env vars needed for this endpoint
---

## 2026-02-07 - US-109
- What was implemented: Parameter override UI — editable building parameters section with confidence badges, Recalculate button, toggle between AI estimate and adjusted estimate. Also added `building_model` to `/api/analyze` response and `estimateFromModel` API client function.
- Files changed:
  - `backend/cantena/api/app.py` — added `building_model` field to `/api/analyze` response (from VlmAnalysisResult)
  - `frontend/src/lib/types.ts` — added `building_model: BuildingModel` to `AnalyzeResponse` interface
  - `frontend/src/lib/api.ts` — added `estimateFromModel(building)` function POSTing to `/api/estimate`
  - `frontend/src/app/analyze/page.tsx` — added `BuildingParametersEditor` component with editable dropdowns/inputs, `FieldWithConfidence` wrapper, recalculate logic, AI/Adjusted toggle, human-readable enum label maps
- **Learnings for future iterations:**
  - Backend `/api/analyze` must include `building_model` in response so frontend can populate editable fields — was added to `result.analysis.building_model.model_dump()`
  - `structuredClone()` is the clean way to deep-copy BuildingModel for React state (avoids mutation of original)
  - `JSON.stringify` comparison works for change detection on BuildingModel since field order is deterministic from API
  - Enum label maps (`BUILDING_TYPE_LABELS`, `STRUCTURAL_LABELS`, `EXTERIOR_LABELS`) convert snake_case values to human-readable labels
  - FieldWithConfidence wraps each editable field with label + confidence badge — keeps the grid layout clean
  - Toggle between AI and adjusted estimates uses simple boolean state + conditional rendering
---

