## Codebase Patterns
- Python 3.11+ with pydantic v2 for domain models
- Project lives in `backend/` — source in `backend/cantena/`, tests in `backend/tests/`
- Quality gates: `pytest`, `mypy --strict cantena`, `ruff check cantena tests` (run from backend/ with venv activated)
- Use `source .venv/bin/activate` before running any Python tooling
- Frontend lives in `frontend/` — Next.js 14+ App Router with TypeScript strict mode
- Frontend quality gates: `npm run typecheck`, `npm run lint` (run from frontend/)
- Landing page at `/` is out of scope — product work lives under `/analyze` route
- Cost engine foundation (PRD 1) is complete — all models, engine, data, and formatting in `cantena/`
- Frontend types in `frontend/src/lib/types.ts` must mirror Python models exactly (enums as TS enums, interfaces for Pydantic models)
- Frontend API client in `frontend/src/lib/api.ts` — typed fetch wrappers
- `npm install` required before running quality gates (node_modules not committed)
- Use `npm run typecheck` and `npm run lint` from `frontend/` directory
- Services live in `cantena/services/` — new package created for PDF, VLM, pipeline services
- PyMuPDF (`fitz`) needs `# type: ignore[import-untyped]` for mypy (no stubs available)
- `anthropic` SDK has type stubs — do NOT add `# type: ignore[import-untyped]`
- Use `ImageBlockParam` and `TextBlockParam` from `anthropic.types` for typed message content
- System prompt strings must stay within 100-char line limit — use string concatenation `()`
- Use dataclasses (not Pydantic) for internal service result types — Pydantic reserved for domain models
- Empty PDFs (0 pages) are valid and should return empty result, not error
- Custom exceptions in `cantena/exceptions.py`: CantenaError base, PdfProcessingError, VlmAnalysisError, CostEstimationError
- Pipeline wraps errors from each stage into typed exceptions — don't double-wrap if already the correct type
- Use `TYPE_CHECKING` block for imports only used in type annotations (TC001/TC003) — runtime imports stay outside
- `AnalysisContext` from `vlm_analyzer` is used at runtime (instantiated in pipeline) — keep outside TYPE_CHECKING

---

## 2026-02-07 - US-101
- What was implemented: Frontend scaffolding — added typecheck script, TypeScript interfaces matching all Python Pydantic models, typed API fetch wrapper, and /analyze page entry point.
- Files changed:
  - `frontend/package.json` — added `typecheck: "tsc --noEmit"` script
  - `frontend/src/lib/types.ts` — TypeScript enums and interfaces for BuildingType, StructuralSystem, ExteriorWall, MechanicalSystem, ElectricalService, FireProtection, Confidence, Location, ComplexityScores, BuildingModel, CostRange, DivisionCost, Assumption, BuildingSummary, EstimateMetadata, CostEstimate
  - `frontend/src/lib/api.ts` — `analyzePlan(file, location)` fetch wrapper targeting POST /api/analyze
  - `frontend/src/app/analyze/page.tsx` — minimal product analysis page at /analyze route
- **Learnings for future iterations:**
  - Node modules must be installed first (`npm install` from frontend/) before running quality gates
  - TypeScript enums match Python StrEnum values exactly — use string values not uppercase keys
  - `generated_at` is `string` in TS (JSON serialized datetime) not Date object
  - Path alias `@/*` maps to `./src/*` — use `@/lib/types` for imports
  - The PRD says `frontend/lib/types.ts` but actual path is `frontend/src/lib/types.ts` (under src/ per Next.js App Router convention)
---

## 2026-02-07 - US-102
- What was implemented: PDF processing service — PdfProcessor class that converts PDF pages to 200 DPI PNG images with text extraction and title block heuristic.
- Files changed:
  - `backend/pyproject.toml` — added PyMuPDF and Pillow dependencies
  - `backend/cantena/services/__init__.py` — new services package
  - `backend/cantena/services/pdf_processor.py` — PdfProcessor, PageResult, PdfProcessingResult classes
  - `backend/tests/test_pdf_processor.py` — 11 tests covering processing, text extraction, cleanup, and error handling
- **Learnings for future iterations:**
  - PyMuPDF (`import fitz`) has no type stubs — use `# type: ignore[import-untyped]` on the import
  - PyMuPDF cannot save a zero-page PDF (`ValueError: cannot save with zero pages`) — create test empty PDFs with raw bytes instead
  - Output directories must be created before fitz tries to write images (`mkdir(parents=True, exist_ok=True)`)
  - fitz uses 72 DPI as baseline — zoom factor = target_dpi / 72 (e.g., 200/72 ≈ 2.78)
  - Title block text lives in the bottom-right quadrant of construction drawings — use `page.get_text(clip=rect)` for extraction
  - Use `contextlib.suppress(OSError)` instead of try/except/pass per ruff SIM105
  - ruff `--fix` auto-handles I001 import sorting
---

## 2026-02-07 - US-103
- What was implemented: VLM analysis service — VlmAnalyzer class that sends construction drawing images to Anthropic Vision API and returns a structured BuildingModel.
- Files changed:
  - `backend/cantena/services/vlm_analyzer.py` — VlmAnalyzer, AnalysisContext, VlmAnalysisResult classes, SYSTEM_PROMPT constant
  - `backend/tests/test_vlm_analyzer.py` — 13 tests covering well-formed parsing, retry on malformed, missing field defaults, context passthrough, error handling
  - `backend/pyproject.toml` — added `anthropic>=0.39.0` dependency
- **Learnings for future iterations:**
  - `anthropic` SDK ships with type stubs — no `type: ignore` needed (unlike PyMuPDF)
  - Use `ImageBlockParam` and `TextBlockParam` from `anthropic.types` for typed API content arrays
  - mypy requires proper typed dicts for Anthropic API `messages[].content` — plain `dict[str, Any]` fails
  - Long string constants (system prompts) must use `()` string concatenation to stay under 100-char line limit for ruff E501
  - Mock `analyzer._client.messages.create` with `patch.object` for testing — mock response needs `.content[].type` and `.content[].text` attributes
  - Create minimal valid PNGs in tests using raw struct/zlib — no need for Pillow in test deps
  - Use `with (ctx1, ctx2):` syntax (Python 3.10+) instead of nested `with` per ruff SIM117
---

## 2026-02-07 - US-104
- What was implemented: Analysis pipeline — AnalysisPipeline orchestrator that chains PDF → VLM → CostEngine, plus custom exception hierarchy in cantena/exceptions.py.
- Files changed:
  - `backend/cantena/exceptions.py` — CantenaError base, PdfProcessingError, VlmAnalysisError, CostEstimationError
  - `backend/cantena/services/pipeline.py` — AnalysisPipeline class, PipelineResult dataclass, page selection heuristic
  - `backend/tests/test_pipeline.py` — 14 tests covering happy path, page selection, error wrapping, cleanup on failure
- **Learnings for future iterations:**
  - Pipeline wraps errors from each stage into typed exceptions — use `isinstance` check to avoid double-wrapping
  - Page selection heuristic: title block "floor plan" match > largest page by pixel area > page 1
  - `AnalysisContext` is used at runtime (instantiated in `analyze()`) — must import outside `TYPE_CHECKING`
  - All other pipeline type imports (`PdfProcessor`, `VlmAnalyzer`, `CostEngine`, result types) can go in `TYPE_CHECKING` since they're only in annotations
  - `time.monotonic()` for timing (not `time.time()`) — monotonic is not affected by system clock changes
  - `finally` block ensures cleanup even on exceptions — check `pdf_result is not None` before calling cleanup
  - Use `MagicMock(spec=ClassName)` for service mocks in tests — catches wrong method names
---

